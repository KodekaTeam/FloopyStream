<% layout('dashboard/layout') %>

<div class="flex h-screen bg-gray-900 overflow-hidden">
  <%- include('partials/navbar') %> <%- include('partials/sidebar') %>

  <!-- Main Content -->
  <main class="flex-1 overflow-auto lg:ml-20 pt-16">
    <div class="p-4 sm:p-6 lg:p-8">
      <!-- Header -->
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 sm:mb-8"
      >
        <div>
          <h2 class="text-2xl sm:text-3xl font-bold text-white">
            Broadcast History
          </h2>
          <p class="text-sm sm:text-base text-gray-400 mt-1">
            View all your past broadcasts
          </p>
        </div>

        <div class="flex flex-wrap gap-2 sm:gap-4 w-full sm:w-auto">
          <button
            onclick="exportHistory()"
            class="flex-1 sm:flex-initial px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors flex items-center justify-center gap-2 text-sm"
          >
            <i class="ti ti-download"></i>
            <span>Export</span>
          </button>
          <button
            onclick="clearHistory()"
            class="flex-1 sm:flex-initial px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors flex items-center justify-center gap-2 text-sm"
          >
            <i class="ti ti-trash"></i>
            <span>Clear History</span>
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Total Broadcasts</p>
              <p class="text-2xl font-bold text-white mt-1">
                <%= broadcasts.length %>
              </p>
            </div>
            <div class="p-3 bg-blue-600 bg-opacity-20 rounded-lg">
              <i class="ti ti-live-view text-2xl text-blue-400"></i>
            </div>
          </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Completed</p>
              <p class="text-2xl font-bold text-green-400 mt-1">
                <%= broadcasts.filter(b => b.broadcast_status ===
                'completed').length %>
              </p>
            </div>
            <div class="p-3 bg-green-600 bg-opacity-20 rounded-lg">
              <i class="ti ti-circle-check text-2xl text-green-400"></i>
            </div>
          </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Failed</p>
              <p class="text-2xl font-bold text-red-400 mt-1">
                <%= broadcasts.filter(b => b.broadcast_status ===
                'failed').length %>
              </p>
            </div>
            <div class="p-3 bg-red-600 bg-opacity-20 rounded-lg">
              <i class="ti ti-alert-circle text-2xl text-red-400"></i>
            </div>
          </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Total Duration</p>
              <p class="text-2xl font-bold text-white mt-1" id="totalDuration">
                0h 0m
              </p>
            </div>
            <div class="p-3 bg-purple-600 bg-opacity-20 rounded-lg">
              <i class="ti ti-clock text-2xl text-purple-400"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 mb-6">
        <div class="flex flex-wrap gap-4">
          <div class="flex-1 min-w-[250px]">
            <input
              type="text"
              id="searchHistory"
              placeholder="Search broadcasts..."
              class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
            />
          </div>

          <select
            id="filterStatus"
            onchange="filterHistory()"
            class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500"
          >
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="completed">Completed</option>
            <option value="scheduled">Scheduled</option>
            <option value="failed">Failed</option>
          </select>

          <select
            id="filterPlatform"
            onchange="filterHistory()"
            class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500"
          >
            <option value="all">All Platforms</option>
            <option value="youtube">YouTube</option>
            <option value="facebook">Facebook</option>
            <option value="twitch">Twitch</option>
            <option value="tiktok">TikTok</option>
            <option value="instagram">Instagram</option>
            <option value="custom">Custom</option>
          </select>

          <input
            type="date"
            id="filterDate"
            onchange="filterHistory()"
            class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500"
          />
        </div>
      </div>

      <!-- History Table -->
      <div
        class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden"
      >
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-900 border-b border-gray-700">
              <tr>
                <th
                  class="px-6 py-4 text-left text-sm font-semibold text-gray-300"
                >
                  Stream Info
                </th>
                <th
                  class="px-6 py-4 text-left text-sm font-semibold text-gray-300"
                >
                  Platform
                </th>
                <th
                  class="px-6 py-4 text-left text-sm font-semibold text-gray-300"
                >
                  Start Time
                </th>
                <th
                  class="px-6 py-4 text-left text-sm font-semibold text-gray-300"
                >
                  End Time
                </th>
                <th
                  class="px-6 py-4 text-left text-sm font-semibold text-gray-300"
                >
                  Duration
                </th>
                <th
                  class="px-6 py-4 text-left text-sm font-semibold text-gray-300"
                >
                  Status
                </th>
                <th
                  class="px-6 py-4 text-left text-sm font-semibold text-gray-300"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-700" id="historyTableBody">
              <% if (broadcasts.length === 0) { %>
              <tr>
                <td colspan="7" class="px-6 py-12 text-center">
                  <div class="flex flex-col items-center gap-3">
                    <i class="ti ti-history text-5xl text-gray-600"></i>
                    <p class="text-gray-400">No broadcast history found</p>
                  </div>
                </td>
              </tr>
              <% } else { %> <% broadcasts.forEach(broadcast => { %>
              <tr
                class="hover:bg-gray-700 transition-colors broadcast-row"
                data-status="<%= broadcast.broadcast_status %>"
                data-platform="<%= broadcast.platform_name.toLowerCase() %>"
                data-date="<%= broadcast.created_at %>"
              >
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                    <div class="w-16 h-10 bg-gray-700 rounded overflow-hidden">
                      <% if (broadcast.thumbnail_path) { %>
                      <img
                        src="/storage/thumbnails/<%= broadcast.thumbnail_path %>"
                        alt="Thumbnail"
                        class="w-full h-full object-cover"
                      />
                      <% } else { %>
                      <div
                        class="w-full h-full flex items-center justify-center"
                      >
                        <i class="ti ti-video text-gray-500"></i>
                      </div>
                      <% } %>
                    </div>
                    <div>
                      <p class="text-white font-medium">
                        <%= broadcast.broadcast_name || 'Untitled Broadcast' %>
                      </p>
                      <p class="text-sm text-gray-400">
                        ID: <%= broadcast.broadcast_id %>
                      </p>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center gap-2">
                    <% const platformIcons = { youtube: 'brand-youtube',
                    facebook: 'brand-facebook', twitch: 'brand-twitch', tiktok:
                    'brand-tiktok', instagram: 'brand-instagram' }; const icon =
                    platformIcons[broadcast.platform_name.toLowerCase()] ||
                    'cast'; %>
                    <i class="ti ti-<%= icon %> text-xl text-gray-400"></i>
                    <span class="text-white capitalize"
                      ><%= broadcast.platform_name %></span
                    >
                  </div>
                </td>
                <td class="px-6 py-4 text-gray-300">
                  <%= new Date(broadcast.created_at).toLocaleString() %>
                </td>
                <td class="px-6 py-4 text-gray-300">
                  <%= broadcast.updated_at ? new
                  Date(broadcast.updated_at).toLocaleString() : '-' %>
                </td>
                <td class="px-6 py-4 text-gray-300">
                  <%= broadcast.duration_seconds ?
                  Math.floor(broadcast.duration_seconds / 60) + 'm' : '-' %>
                </td>
                <td class="px-6 py-4">
                  <% const statusColors = { active: 'bg-green-600', completed:
                  'bg-blue-600', scheduled: 'bg-yellow-600', failed:
                  'bg-red-600' }; const color =
                  statusColors[broadcast.broadcast_status] || 'bg-gray-600'; %>
                  <span
                    class="px-3 py-1 rounded-full text-xs font-medium text-white <%= color %>"
                  >
                    <%= broadcast.broadcast_status.toUpperCase() %>
                  </span>
                </td>
                <td class="px-6 py-4">
                  <div class="flex gap-2">
                    <button
                      onclick="viewBroadcastDetails('<%= broadcast.broadcast_id %>')"
                      class="p-2 text-blue-400 hover:bg-gray-600 rounded transition-colors"
                      title="View Details"
                    >
                      <i class="ti ti-eye"></i>
                    </button>
                    <button
                      onclick="deleteBroadcast('<%= broadcast.broadcast_id %>')"
                      class="p-2 text-red-400 hover:bg-gray-600 rounded transition-colors"
                      title="Delete"
                    >
                      <i class="ti ti-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <% }) %> <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<script src="/js/history.js"></script>
<script>
  // Calculate total duration on page load
  document.addEventListener("DOMContentLoaded", () => {
    const broadcasts = JSON.parse("<%= JSON.stringify(broadcasts) %>");
    const totalSeconds = broadcasts.reduce(
      (sum, b) => sum + (b.duration_seconds || 0),
      0
    );
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    document.getElementById(
      "totalDuration"
    ).textContent = `${hours}h ${minutes}m`;
  });
</script>
